<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:p="http://primefaces.org/ui">

<h:head>
</h:head>
<h:body>
        <p:growl id="msj" widgetVar="wmsj" showDetail="false" />
        
        <p:socket onMessage="handleMessage" channel="/main" >
            <p:ajax event="message" update=":form:droppable" />
        </p:socket>
        
        <script type="text/javascript">
	        function handleMessage(facesmessage) {
	            facesmessage.severity = 'info';
	
// 	            PF('wmsj').show([facesmessage]);

	            var array = facesmessage.detail.split(" ");
				
				document.getElementById(array[1]).style.left = array[3]+'px';
	            document.getElementById(array[1]).style.top = array[5]+'px';
				
	        }
        </script>
        
        <h:form id="form">
            <p:panel id="draggable1" widgetVar="dg1" style="z-index:1; width: 60px; height: 60px; left: #{mainBean.left}px; top: #{mainBean.top}px" >
                <h:outputText value="Mago 1" />
                <p:draggable for="draggable1" revert ="false" grid="60,60" opacity="0.3"/>
            </p:panel>
<!-- 	tentar usar restricao na proxima versao -->
            <p:panel id="droppable" style="z-index:1; width: 600px; height: 600px;">
                <p:droppable widgetVar="dropWV" for="droppable"> 
                    <p:ajax listener="#{mainBean.onDrop}" />
                </p:droppable>
            </p:panel>          
        </h:form>
        
        <script>
            //<![CDATA[
            PrimeFaces.widget.Droppable.prototype.bindDropListener = function() {
                var _self = this;
                this.cfg.drop = function(event, ui) {
                    if (_self.cfg.onDrop) {
                        _self.cfg.onDrop.call(_self, event, ui);
                    }
                    if (_self.cfg.behaviors) {
                        var dropBehavior = _self.cfg.behaviors['drop'];
                        if (dropBehavior) {
                            var ext = {
                                params: [
                                    {name: _self.id + '_dragId', value: ui.draggable.attr('id')},
                                    {name: _self.id + '_dropId', value: _self.cfg.target},
                                    {name: ui.draggable.attr('id') + '_left', value: ui.position.left},
                                    {name: ui.draggable.attr('id') + '_top', value: ui.position.top}
                                ]
                            };
                            console.log(ui);
                            dropBehavior.call(_self, ext);
                        }
                    }
                };
            }
            // ]]>
        </script>
</h:body>
</html>     